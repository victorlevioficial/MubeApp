{
    "rules": {
        "chats": {
            "$conversationId": {
                ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                ".write": "auth != null && (root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true || (!data.exists() && newData.child('participants').child(auth.uid).val() === true))",
                "participants": {
                    ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                    ".write": "auth != null && !data.exists() && newData.child(auth.uid).val() === true",
                    "$uid": {
                        ".validate": "newData.isBoolean() && newData.val() === true"
                    }
                },
                "metadata": {
                    ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                    ".write": "auth != null && (root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true || newData.parent().child('participants').child(auth.uid).val() === true)",
                    "lastMessage": {
                        ".validate": "!newData.exists() || (newData.isString() && newData.val().length > 0 && newData.val().length <= 1000)"
                    },
                    "lastMessageTime": {
                        ".validate": "!newData.exists() || newData.isNumber() || (newData.hasChildren(['.sv']) && newData.child('.sv').val() === 'timestamp')"
                    },
                    "lastSenderId": {
                        ".validate": "!newData.exists() || (newData.isString() && newData.val() === auth.uid)"
                    },
                    "$other": {
                        ".validate": false
                    }
                },
                "messages": {
                    ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                    ".indexOn": [
                        "timestamp"
                    ],
                    "$messageId": {
                        ".write": "auth != null && (root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true || newData.parent().child('participants').child(auth.uid).val() === true)",
                        "senderId": {
                            ".validate": "newData.isString() && newData.val() === auth.uid"
                        },
                        "text": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 1000"
                        },
                        "timestamp": {
                            ".validate": "newData.isNumber() || (newData.hasChildren(['.sv']) && newData.child('.sv').val() === 'timestamp')"
                        }
                    }
                },
                "unreadCount": {
                    ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                    "$uid": {
                        ".write": "auth != null && (root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true || newData.parent().parent().child('participants').child(auth.uid).val() === true)",
                        ".validate": "newData.isNumber() && newData.val() >= 0"
                    }
                },
                "readUntil": {
                    ".read": "auth != null && root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true",
                    "$uid": {
                        ".write": "auth != null && $uid === auth.uid && (root.child('chats').child($conversationId).child('participants').child(auth.uid).val() === true || newData.parent().parent().child('participants').child(auth.uid).val() === true)",
                        ".validate": "newData.isNumber() && newData.val() >= 0"
                    }
                },
                "$other": {
                    ".validate": false
                }
            }
        },
        "userChats": {
            "$userId": {
                ".read": "auth != null && $userId === auth.uid",
                ".indexOn": [
                    "lastMessageTime"
                ],
                "$conversationId": {
                    ".write": "auth != null && ($userId === auth.uid || (newData.exists() && newData.child('otherUserId').val() === auth.uid) || (data.exists() && data.child('otherUserId').val() === auth.uid))",
                    "otherUserId": {
                        ".validate": "!newData.exists() || newData.isString()"
                    },
                    "otherUserName": {
                        ".validate": "!newData.exists() || newData.isString()"
                    },
                    "otherUserPhoto": {
                        ".validate": "!newData.exists() || newData.isString()"
                    },
                    "lastMessage": {
                        ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 1000)"
                    },
                    "lastMessageTime": {
                        ".validate": "!newData.exists() || newData.isNumber() || (newData.hasChildren(['.sv']) && newData.child('.sv').val() === 'timestamp')"
                    },
                    "lastSenderId": {
                        ".validate": "!newData.exists() || newData.isString()"
                    },
                    "unreadCount": {
                        ".validate": "!newData.exists() || (newData.isNumber() && newData.val() >= 0) || (newData.hasChildren(['.sv']) && newData.child('.sv').hasChildren(['increment']))"
                    },
                    "readUntil": {
                        ".validate": "!newData.exists() || (newData.isNumber() && newData.val() >= 0) || (newData.hasChildren(['.sv']) && newData.child('.sv').hasChildren(['increment']))"
                    }
                }
            }
        }
    }
}