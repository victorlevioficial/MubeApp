rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================================================================
    // CONFIG - Configurações do App (Gêneros, Instrumentos, etc)
    // ================================================================
    match /config/{document=**} {
      allow read, write: if request.auth != null;
    }

    // ================================================================
    // USERS - Perfis de Usuários
    // ================================================================
    match /users/{userId} {
      // Qualquer autenticado pode ler perfis
      allow read: if request.auth != null;
      
      // PERMISSÃO DE SEEDING: Allow create if authenticated (removed uid check for create only)
      allow create: if request.auth != null;
      
      // Delete: owner OR seeded users (for dev cleanup - email ends with @seeded.mube.app)
      // ⚠️ DEV ONLY: Remove the seeded check for production!
      allow delete: if request.auth != null && 
        (request.auth.uid == userId || 
         resource.data.email.matches('.*@seeded[.]mube[.]app$'));

      // Update: próprio usuário, likeCount, ou members (para entrar em banda)
      allow update: if request.auth != null && 
        (request.auth.uid == userId || 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) ||
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']));
      
      // ================================================================
      // FAVORITES - Subcoleção de favoritos por usuário
      // ================================================================
      match /favorites/{favoriteId} {
        // Usuário só pode ler/escrever seus próprios favoritos
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // CHAT - Conversas e mensagens
      // ================================================================
      match /conversationPreviews/{conversationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }


      // ================================================================
      // INTERACTIONS - Likes/Dislikes (MatchPoint)
      // ================================================================
      match /interactions/{interactionId} {
         // Owner can read/write their own interactions
         // The 'interactionId' is the ID of the person interacted with.
         // If I am User A, and I like User B, the doc is users/A/interactions/B.
         //   - I (User A) need read/write access. (Covered by request.auth.uid == userId)
         
         // Mutual Match Check:
         // If User B wants to know if User A liked them, User B checks users/A/interactions/B.
         //   - User B (interactionId) needs READ access to users/A/interactions/B.
         allow read: if request.auth != null && (request.auth.uid == userId || request.auth.uid == interactionId);
         allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ================================================================
    // CONVERSATIONS - Mensagens reais
    // ================================================================
    match /conversations/{conversationId} {
      // Permite ler/escrever se o UID do usuário estiver na lista de participantes
      allow read, write: if request.auth != null && 
        (resource == null || request.auth.uid in resource.data.participants);
      
      match /messages/{messageId} {
        // Permite ler/escrever mensagens se tiver acesso à conversa pai
        allow read, write: if request.auth != null; 
      }
    }

    // ================================================================
    // INVITES - Convites para bandas
    // ================================================================
      match /invites/{inviteId} {
         // Allow read if user is the target OR the band (admin)
         allow read: if request.auth != null && (
           resource.data.target_uid == request.auth.uid || 
           resource.data.band_id == request.auth.uid
         );
         // Allow create if auth (for sending invites)
         allow create: if request.auth != null;
         // Allow update if target (accept/decline) or band (cancel)
         allow update: if request.auth != null && (
           resource.data.target_uid == request.auth.uid || 
           resource.data.band_id == request.auth.uid
         );
         // Allow delete if band (cancel)
         allow delete: if request.auth != null && resource.data.band_id == request.auth.uid;
      }

    // ================================================================
    // PROFILES - Coleção pública/global (Counter mirror)
    // ================================================================
    match /profiles/{profileId} {
      // Qualquer autenticado pode ler
      allow read: if request.auth != null;
      
      // Permite atualizar APENAS o campo likeCount (qualquer usuário autenticado)
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']);
        
      // Criação/Deleção restrita (geralmente feita por Cloud Functions ou Admin SDK, 
      // ou pelo próprio usuário se profiles for espelho de users. 
      // O repo atual apenas atualiza se existir.
    }
    
    // ================================================================
    // FALLBACK
    // ================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
