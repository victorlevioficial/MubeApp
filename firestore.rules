rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================================================================
    // CONFIG - Configurações do App (Gêneros, Instrumentos, etc)
    // ================================================================
    match /config/{document=**} {
      // Read-only for authenticated users
      // Write only via Admin SDK or Cloud Functions
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ================================================================
    // USERS - Perfis de Usuários
    // ================================================================
    match /users/{userId} {
      // Qualquer autenticado pode ler perfis
      allow read: if request.auth != null;
      
      // Apenas o próprio usuário pode criar seu perfil
      // O UID deve corresponder ao usuário autenticado
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Only owner can delete their own account
      allow delete: if request.auth != null && request.auth.uid == userId;

      // Update: próprio usuário, likeCount, ou members (para entrar em banda)
      allow update: if request.auth != null && 
        (request.auth.uid == userId || 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']) ||
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']));
      
      // ================================================================
      // FAVORITES - Subcoleção de favoritos por usuário
      // ================================================================
      match /favorites/{favoriteId} {
        // Usuário só pode ler/escrever seus próprios favoritos
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // BLOCKED - Usuários bloqueados
      // ================================================================
      match /blocked/{blockedId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // CHAT - Conversas e mensagens
      // ================================================================
      match /conversationPreviews/{conversationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }


      // ================================================================
      // INTERACTIONS - Likes/Dislikes (MatchPoint)
      // ================================================================
      match /interactions/{interactionId} {
         // Owner can read/write their own interactions
         // The 'interactionId' is the ID of the person interacted with.
         // If I am User A, and I like User B, the doc is users/A/interactions/B.
         //   - I (User A) need read/write access. (Covered by request.auth.uid == userId)
         
         // Mutual Match Check:
         // If User B wants to know if User A liked them, User B checks users/A/interactions/B.
         //   - User B (interactionId) needs READ access to users/A/interactions/B.
         allow read: if request.auth != null && (request.auth.uid == userId || request.auth.uid == interactionId);
         allow write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // CONVERSATION PREVIEWS - Lista de conversas do usuário
      // ================================================================
      match /conversationPreviews/{previewId} {
        // User can read their own previews
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Any authenticated user can create/update previews (for chat initiation)
        // This is needed because when User A starts a chat with User B,
        // User A needs to create a preview in User B's subcollection
        allow create, update: if request.auth != null && 
          request.auth.uid in previewId.split('_');
        
        // Only owner can delete their own previews
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // NOTIFICATIONS - Push notification history
      // ================================================================
      match /notifications/{notificationId} {
        // User can read/write/delete their own notifications
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ================================================================
    // CONVERSATIONS - Mensagens reais
    // ================================================================
    match /conversations/{conversationId} {
      // Helper: check if user's UID is part of the conversationId (uid1_uid2 format)
      function isParticipantByConversationId() {
        return request.auth.uid in conversationId.split('_');
      }
      
      // Read: conversationId contains user's UID (safe for both existing and new docs)
      allow read: if request.auth != null && isParticipantByConversationId();
      
      // Create: user must be in the new document's participants AND in conversationId
      allow create: if request.auth != null && 
        isParticipantByConversationId() &&
        request.auth.uid in request.resource.data.participants;
      
      // Update: conversationId contains user's UID
      allow update: if request.auth != null && isParticipantByConversationId();
      
      match /messages/{messageId} {
        // Only participants can access messages (use parent's conversationId check)
        allow read, write: if request.auth != null && 
          request.auth.uid in conversationId.split('_');
      }
    }

    // ================================================================
    // INVITES - Convites para bandas
    // ================================================================
      match /invites/{inviteId} {
         // Allow read if user is the target OR the band (admin)
         allow read: if request.auth != null && (
           resource.data.target_uid == request.auth.uid || 
           resource.data.band_id == request.auth.uid
         );
         // Allow create if auth (for sending invites)
         allow create: if request.auth != null;
         // Allow update if target (accept/decline) or band (cancel)
         allow update: if request.auth != null && (
           resource.data.target_uid == request.auth.uid || 
           resource.data.band_id == request.auth.uid
         );
         // Allow delete if band (cancel)
         allow delete: if request.auth != null && resource.data.band_id == request.auth.uid;
      }

    // ================================================================
    // PROFILES - Coleção pública/global (Counter mirror)
    // ================================================================
    match /profiles/{profileId} {
      // Qualquer autenticado pode ler
      allow read: if request.auth != null;
      
      // Permite atualizar APENAS o campo likeCount (qualquer usuário autenticado)
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']);
        
      // Criação/Deleção restrita (geralmente feita por Cloud Functions ou Admin SDK, 
      // ou pelo próprio usuário se profiles for espelho de users. 
      // O repo atual apenas atualiza se existir.
    }

    // ================================================================
    // REPORTS - Denúncias
    // ================================================================
    match /reports/{reportId} {
      // Create: Authenticated users can report
      allow create: if request.auth != null;
      // Read/Update/Delete: Admins only (not implemented in client yet)
      allow read, update, delete: if false; 
    }
    
    // ================================================================
    // FALLBACK
    // ================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
