rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================================================================
    // FUNÇÕES AUXILIARES
    // ================================================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isParticipantByConversationId(conversationId) {
      return request.auth != null && request.auth.uid in conversationId.split('_');
    }

    function hasMatchForConversation(conversationId) {
      return exists(
        /databases/$(database)/documents/matches/$('match_' + conversationId)
      );
    }
    
    // ================================================================
    // CONFIG - Configurações do App (Gêneros, Instrumentos, etc)
    // ================================================================
    match /config/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas via Admin SDK ou Cloud Functions
    }

    // ================================================================
    // USERS - Perfis de Usuários
    // ================================================================
    match /users/{userId} {
      // Qualquer autenticado pode ler perfis
      allow read: if request.auth != null;
      
      // Apenas o próprio usuário pode criar seu perfil
      // e sem campos sensíveis gerenciados pelo backend.
      allow create: if isOwner(userId)
        && request.resource.data.uid == request.auth.uid
        && !request.resource.data.keys().hasAny([
          'status',
          'report_count',
          'report_count_total',
          'suspended_until',
          'suspension_end_date',
          'daily_likes_count',
          'last_like_date',
          'daily_swipes_count',
          'last_swipe_date',
          'total_likes_sent',
          'total_dislikes_sent',
          'likeCount',
          'favorites_count',
          'members',
          'private_stats',
          'plan'
        ]);
      
      // Only owner can delete their own account
      allow delete: if request.auth != null && request.auth.uid == userId;

      // Update: próprio usuário pode atualizar seus dados
      // Campos sensíveis são bloqueados para alterações client-side
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'status',
          'report_count',
          'report_count_total',
          'suspended_until',
          'suspension_end_date',
          'daily_likes_count',
          'last_like_date',
          'daily_swipes_count',
          'last_swipe_date',
          'total_likes_sent',
          'total_dislikes_sent',
          'likeCount',
          'favorites_count',
          'members',
          'private_stats',
          'plan'
        ]);
      
      // ================================================================
      // FAVORITES - Subcoleção de favoritos por usuário
      // ================================================================
      match /favorites/{favoriteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // BLOCKED - Usuários bloqueados
      // ================================================================
      match /blocked/{blockedId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ================================================================
      // CONVERSATION PREVIEWS - Lista de conversas do usuário
      // ================================================================
      match /conversationPreviews/{previewId} {
        // User can read their own previews
        allow read: if isOwner(userId);
        
        // Participantes podem criar/atualizar (para sync de previews)
        allow create, update: if isAuthenticated() && isParticipantByConversationId(previewId);
        
        // Only owner can delete their own previews
        allow delete: if isOwner(userId);
      }

      // ================================================================
      // NOTIFICATIONS - Push notification history
      // ================================================================
      match /notifications/{notificationId} {
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ================================================================
    // INTERACTIONS - Likes/Dislikes (MatchPoint) - COLEÇÃO GLOBAL
    // ================================================================
    match /interactions/{interactionId} {
      // Apenas Cloud Functions podem criar - bloqueado para client-side
      allow read: if request.auth != null && 
        (resource.data.source_user_id == request.auth.uid || 
         resource.data.target_user_id == request.auth.uid);
      allow create, update, delete: if false;
    }

    // ================================================================
    // MATCHES - Matches entre usuários
    // ================================================================
    match /matches/{matchId} {
      // Ler se for um dos participantes
      // Suporta tanto queries por user_id_1/user_id_2 quanto por user_ids (arrayContains)
      allow read: if request.auth != null && 
        (resource.data.user_id_1 == request.auth.uid || 
         resource.data.user_id_2 == request.auth.uid ||
         request.auth.uid in resource.data.user_ids);
      
      // Apenas Cloud Functions podem criar matches
      allow create, update, delete: if false;
    }

    // ================================================================
    // CONVERSATIONS - Mensagens reais
    // ================================================================
    match /conversations/{conversationId} {
      // Read: user must be participant
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Create: client-side create only after a valid match already exists.
      allow create: if isAuthenticated()
        && conversationId.split('_').size() == 2
        && request.resource.data.participants is list
        && request.resource.data.participants.size() == 2
        && request.resource.data.participants.hasAll(conversationId.split('_'))
        && request.auth.uid in request.resource.data.participants
        && hasMatchForConversation(conversationId);
      
      // Update: user must be participant, participants list is immutable.
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.participants
        && request.resource.data.participants == resource.data.participants;
      
      match /messages/{messageId} {
        // Only participants can read messages
        allow read: if isAuthenticated()
          && exists(/databases/$(database)/documents/conversations/$(conversationId))
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Create: user must be participant in the persisted conversation and sender.
        allow create: if isAuthenticated() &&
          exists(/databases/$(database)/documents/conversations/$(conversationId)) &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.text is string &&
          request.resource.data.text.size() > 0 &&
          request.resource.data.createdAt is timestamp;
          
        allow update, delete: if false;
      }
    }

    // ================================================================
    // INVITES - Convites para bandas
    // ================================================================
    match /invites/{inviteId} {
      // Leitura: remetente ou destinatário
      allow read: if isAuthenticated() &&
        (resource.data.target_uid == request.auth.uid ||
         resource.data.sender_uid == request.auth.uid);

      // Escrita: apenas via Cloud Functions
      allow create, update, delete: if false;
    }

    // ================================================================
    // BAND MEMBERSHIPS - Associação usuário-banda
    // ================================================================
    match /bandMemberships/{membershipId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Apenas via Cloud Function
    }

    // ================================================================
    // BANDS - Informações de bandas
    // ================================================================
    match /bands/{bandId} {
      allow read: if request.auth != null;
      
      // Criação: qualquer usuário autenticado pode criar banda
      allow create: if request.auth != null;
      
      // Update: apenas membros com role adequado (verificado na function)
      allow update: if request.auth != null &&
        exists(/databases/$(database)/documents/bandMemberships/$(request.auth.uid + '_' + bandId));
        
      // Delete: apenas via function
      allow delete: if false;
      
      // Subcoleção de membros
      match /members/{memberId} {
        allow read: if request.auth != null;
        allow write: if false; // Apenas via Cloud Function
      }
    }

    // ================================================================
    // REPORTS - Denúncias
    // ================================================================
    match /reports/{reportId} {
      // Create: Authenticated users can report
      allow create: if isAuthenticated() &&
        request.resource.data.reporter_user_id == request.auth.uid &&
        request.resource.data.reported_item_id is string &&
        request.resource.data.reported_item_type is string &&
        request.resource.data.reason is string &&
        request.resource.data.reported_item_id != request.auth.uid;
      
      // Read/Update/Delete: Apenas via Cloud Functions
      allow read, update, delete: if false; 
    }

    // ================================================================
    // SUSPENSIONS - Suspensões de usuários
    // ================================================================
    match /suspensions/{suspensionId} {
      // Usuário pode ler sua própria suspensão
      allow read: if request.auth != null && resource.data.user_id == request.auth.uid;
      allow create, update, delete: if false; // Apenas via Cloud Function
    }

    // ================================================================
    // USER MODERATIONS - Registro de moderação
    // ================================================================
    match /userModerations/{moderationId} {
      // Usuário pode ler sua própria moderação
      allow read: if request.auth != null && resource.data.user_id == request.auth.uid;
      allow create, update, delete: if false; // Apenas via Cloud Function
    }

    // ================================================================
    // HASHTAG RANKING - Ranking de hashtags
    // ================================================================
    match /hashtagRanking/{hashtagId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Apenas via Cloud Function
      
      // Subcoleção de usos diários
      match /dailyUses/{dateId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    // ================================================================
    // PROFILES - Coleção pública/global (Counter mirror)
    // ================================================================
    match /profiles/{profileId} {
      allow read: if request.auth != null;
      
      // Apenas Cloud Functions podem atualizar
      allow create, update, delete: if false;
    }

    // ================================================================
    // POSTS - Posts do feed
    // ================================================================
    match /posts/{postId} {
      allow read: if request.auth != null;
      
      // Create: usuário autenticado
      allow create: if request.auth != null &&
        request.resource.data.author_id == request.auth.uid;
      
      // Update: apenas o autor
      allow update: if request.auth != null &&
        resource.data.author_id == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'report_count',
          'hidden',
          'hidden_reason'
        ]);
      
      // Delete: apenas o autor ou admin (via function)
      allow delete: if request.auth != null && resource.data.author_id == request.auth.uid;
    }

    // ================================================================
    // MATCHPOINT STATS - Estatísticas (apenas leitura)
    // ================================================================



    // ================================================================
    // MATCHPOINT STATS - Estatísticas (apenas leitura)
    // ================================================================
    match /matchpointStats/{statId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // ================================================================
    // TICKETS - Suporte
    // ================================================================
    match /tickets/{ticketId} {
      // User can read their own tickets
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // User can create ticket if they are the owner
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // User cannot update or delete (only admins via functions/console)
      allow update, delete: if false;
    }

    // ================================================================
    // FALLBACK
    // ================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
