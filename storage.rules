rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ========================================
    // PRODUCTION RULES - SECURE
    // ========================================

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Legacy support for profile_photos/{uid}.webp|jpg|png
    function isLegacyProfilePhotoOwner(fileName) {
      return isAuthenticated() &&
        fileName.matches('^' + request.auth.uid + '(\\.(jpg|jpeg|png|webp))?$');
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/(jpeg|png|webp|gif)');
    }

    function isValidVideo() {
      return request.resource.contentType.matches('video/(mp4|quicktime|webm)');
    }

    function isValidPhotoSize() {
      return request.resource.size < 10 * 1024 * 1024; // 10MB
    }

    function isValidVideoSize() {
      return request.resource.size < 50 * 1024 * 1024; // 50MB
    }

    // ========================================
    // PROFILE PHOTOS
    // ========================================

    // New format: profile_photos/{uid}/thumbnail.webp and profile_photos/{uid}/large.webp
    match /profile_photos/{userId}/{allPaths=**} {
      allow read: if true;
      allow create, update: if isAuthenticated()
                             && isOwner(userId)
                             && isValidImage()
                             && isValidPhotoSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Legacy format: profile_photos/{uid}.webp or profile_photos/{uid}
    match /profile_photos/{fileName} {
      allow read: if true;
      allow create, update: if isLegacyProfilePhotoOwner(fileName)
                             && isValidImage()
                             && isValidPhotoSize();
      allow delete: if isLegacyProfilePhotoOwner(fileName);
    }

    // ========================================
    // GALLERY PHOTOS
    // ========================================

    match /gallery_photos/{userId}/{allPaths=**} {
      allow read: if true;
      allow create, update: if isAuthenticated()
                             && isOwner(userId)
                             && isValidImage()
                             && isValidPhotoSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ========================================
    // GALLERY VIDEOS
    // ========================================

    match /gallery_videos/{userId}/{allPaths=**} {
      allow read: if true;
      allow create, update: if isAuthenticated()
                             && isOwner(userId)
                             && isValidVideo()
                             && isValidVideoSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ========================================
    // VIDEO THUMBNAILS
    // ========================================

    match /gallery_thumbnails/{userId}/{allPaths=**} {
      allow read: if true;
      allow create, update: if isAuthenticated()
                             && isOwner(userId)
                             && isValidImage()
                             && isValidPhotoSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ========================================
    // SUPPORT TICKET ATTACHMENTS
    // ========================================

    match /support_tickets/{userId}/{ticketId}/{allPaths=**} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create, update: if isAuthenticated()
                             && isOwner(userId)
                             && isValidImage()
                             && isValidPhotoSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ========================================
    // FALLBACK - DENY EVERYTHING ELSE
    // ========================================

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
